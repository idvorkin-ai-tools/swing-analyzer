# Retro: Week of Dec 7-14, 2025

**Focus:** Workflow optimization, mistake patterns, test improvements

---

## Friction Analysis (from Claude logs)

### 1. PR/Git Target Confusion (CRITICAL - 12+ instances)

**Pattern:** Claude targets wrong branch/repo for PRs

```
"No, make the PR against origin/main"
"Wait should this not be on a PR?"
"Wait what? You should never be merging to main"
"Fork first"
"NO should only have that fix not the other crap"
```

**Root Cause:** Multi-remote setup (origin vs upstream) + fork workflow is confusing

**Fix Applied:**

- CLAUDE.md now explicitly documents: `origin` = ai-tools fork, `upstream` = idvorkin
- Added guardrail: containers NEVER direct commit to main

**Additional Fix Needed:**

- [ ] Add pre-commit hook that warns if committing to main in container
- [ ] Add PR template that asks "Is this against the right branch?"

---

### 2. PR Scope Creep (HIGH - 8+ instances)

**Pattern:** PRs include unrelated changes

```
"NO https://github.com/.../commits should only have that fix not the other crap"
"No - put the PR on main only"
"this PR has 2 parts - can we split into 2 parts"
```

**Root Cause:** Claude bundles convenience fixes with main work

**Fix Needed:**

- [ ] Before creating PR, run `git diff --stat` and verify ONLY requested files
- [ ] Add to CLAUDE.md: "When creating PRs, include ONLY the changes explicitly requested"

---

### 3. Not Reading Existing Code First (MEDIUM - 6+ instances)

**Pattern:** Claude suggests changes without understanding existing logic

```
"No look at the code in origin/main, see what that logic handles"
"Nope look in this codebase and see what it does"
"we still need that it even explains why"
```

**Root Cause:** Jumping to implementation before understanding context

**Fix:** Already in CLAUDE.md but needs reinforcement:

> "NEVER propose changes to code you haven't read"

---

### 4. Destructive Git Operations (CRITICAL - 4 instances)

**Pattern:** Force pushes, bad merges losing work

```
"No 100% wrong. Go look at the ref log. I think you force-pushed by accident"
"No way, dev has a ton of features in the old ref log"
"Nope bad merge - I don't see the filmstrip"
```

**Root Cause:** Aggressive rebase/merge without checking

**Fix Applied:**

- CLAUDE.md: "NEVER use git push --force unless user types 'yes'"
- Pre-push hook blocks force push to main

**Additional Fix Needed:**

- [ ] Before any merge: `git log --oneline -5` to verify what's being merged
- [ ] After merge: `git diff HEAD~1 --stat` to verify changes look right

---

### 5. UI/Feature Misunderstanding (MEDIUM - 5+ instances)

**Pattern:** Implementing something different than requested

```
"No I want only Tailscale and localhost, not all interfaces"
"Nope width is still broken, go back to the original"
"No I mean having the different exercises decide what shows up"
```

**Root Cause:** Not clarifying ambiguous requirements

**Fix Needed:**

- [ ] Before implementing: restate the requirement back to user
- [ ] If multiple interpretations possible, ask which one

---

### 6. Test Hardcoding (MEDIUM - 3+ instances)

**Pattern:** Tests with hardcoded values that break in different environments

```
"No are we hardcoding ports in e2e tests?"
"Make tests config driven"
"Run it locally it's failing"
```

**Root Cause:** Tests written for specific environment

**Fix Needed:**

- [ ] E2E tests should use environment variables for ports
- [ ] Tests should work in CI and locally without modification

---

## Test Strategy Improvements

### Current Issues

1. **Flaky Tests** - 3 tests marked `test.fixme()` due to timing

   - Double-click navigation tests
   - Rapid reload test

2. **Environment Coupling** - Tests assume specific ports/paths

3. **Missing Coverage** - Changes merged without E2E for user-facing features

### Recommended Changes

1. **Before merging any user-facing change:**

   ```bash
   # Run in CLAUDE.md pre-merge checklist
   npx playwright test --grep "relevant-feature"
   ```

2. **For flaky tests:**

   - Use `waitForFunction` instead of fixed timeouts
   - Add retry logic for timing-sensitive assertions
   - Consider using Playwright's `toPass` with retries

3. **Screenshot testing:**
   - Add visual regression tests for UI changes
   - Store screenshots in git-ignored folder
   - Review before merge

---

## Workflow Optimizations

### What's Working Well

1. **Beads for task tracking** - 168 issues closed, 16.5 hr avg lead time
2. **Multi-agent parallelism** - Multiple swing clones working simultaneously
3. **Pre-commit hooks** - Catching issues before they hit remote

### What Needs Improvement

| Problem            | Current State                   | Target State                    |
| ------------------ | ------------------------------- | ------------------------------- |
| PR scope           | Often includes extra changes    | Exactly what was requested      |
| Git target         | Confusion on origin vs upstream | Clear mental model              |
| Force push         | Occasionally loses work         | Never without explicit approval |
| Code understanding | Sometimes jump to changes       | Always read first               |

---

## Action Items

### Immediate (This Week)

1. [ ] Add PR scope check to pre-push hook
2. [ ] Add "restate requirement" step to workflow
3. [ ] Fix 3 flaky E2E tests

### Short Term

1. [ ] Document common git scenarios (rebase conflicts, diverged branches)
2. [ ] Add visual regression testing
3. [ ] Create E2E test for each user-facing feature

### Habits to Build

- **Before any code change:** Read the existing code
- **Before any PR:** `git diff --stat` to verify scope
- **After any merge:** `git diff HEAD~1 --stat` to verify result
- **When requirement is ambiguous:** Ask, don't assume

---

## Metrics to Track

| Metric                  | How to Measure          | Target |
| ----------------------- | ----------------------- | ------ |
| Corrections per session | grep "^no[,. ]" in logs | < 2    |
| PRs needing scope fixes | Manual count            | 0      |
| Force push incidents    | grep "force" in git log | 0      |
| Flaky test count        | test.fixme count        | 0      |

---

## Detailed Friction Examples (from Claude Logs)

### From swing-5 sessions:

1. **"This broke skeleton overlays. Why did we not catch that in a test?"**

   - Root cause: Component tests missing from test hierarchy
   - Fix: Add component test layer between unit and E2E

2. **"I think the poses nav link was an incorrect merge"**

   - Root cause: Merges not reviewed before pushing
   - Fix: After merge, always verify with `git diff HEAD~1 --stat`

3. **"No. I do not want that in the navbar"**

   - Root cause: Assumed feature placement without asking
   - Fix: Restate feature requirement before implementing

4. **Beads sync issues - branch conflicts**
   - Root cause: beads-metadata branch tracking wrong remote
   - Fix: `git branch --set-upstream-to=origin/beads-metadata`

### From swing-6 sessions:

1. **"Wait branch are you on?"**

   - Root cause: Working on wrong branch without realizing
   - Fix: Add branch name to prompt/status display

2. **"wait what are you working on?"**
   - Root cause: Context loss during long sessions
   - Fix: Regularly summarize current task state

### From humane-tracker sessions:

1. **"NO should only have that fix not the other crap"**

   - Root cause: PR scope creep
   - Fix: `git diff --stat` before every PR creation

2. **"No, make the PR against origin/main"**
   - Root cause: Multi-remote confusion
   - Fix: Always state target branch explicitly

---

---

## Specific Instructions to Add to CLAUDE.md

These are actual instructions the user gave that should be permanent guidance:

### Git/PR Rules (User explicitly said these)

```markdown
## Git Rules (from retro)

1. **Container rule**: "If in a container, NEVER direct commit to main, always create a PR"

2. **Merge approval**: "Only a HUMAN can merge to main - must get explicit uppercase YES"

3. **No force push**: "Never do a force push. It's okay for history to be a mess on a branch"

4. **No --no-verify**: "Don't use commit --no-verify unless absolutely necessary"

5. **Lint separately**: "Make separate commits to clean up linting BEFORE the actual change"

6. **Rebase often**: "When working in dev, other agents are pushing all the time - keep rebasing"
```

### Think Like a Senior Dev (User role prompts)

```markdown
## Role Prompts (use when appropriate)

- "You are a really smart engineer - go figure out how to use playwright to see what happens"
- "You are a test architect. Figure out how to do end-to-end testing for this project"
- "I want you to be a really good PM and user researcher - make a recommendation"
- "Look at my code to understand what I've already implemented so I don't have to give me a list of recommendations"
```

### Architecture/Planning (User expectations)

```markdown
## Before Implementing

1. **Spec first**: "Spend a bunch of time thinking. Make the spec before implementing"

2. **Confirm understanding**: "Confirm you understand what I asked you before you go crazy"

3. **Read existing code**: "Look at my code to understand what I've already implemented"

4. **Update architecture docs**: "Do you need to update any architecture files? Perhaps we should create some"

5. **Plan for context loss**: "Make a plan of what you need to do in beads so I can clear your context"
```

### Testing Rules

```markdown
## Testing Rules

1. **Both levels**: "Add UTs AND an E2E test to make sure something is showing up in the UX"

2. **Tests must pass**: "Make sure all our tests pass then go through them in order"

3. **Include in precommit**: "Make sure build passes, include it in linting, include in precommit"

4. **Don't delete tests**: "Did you erase the files? Don't erase them on cleanup"
```

### Debugging Expectations

```markdown
## Debugging

1. **Use session recorder**: "It's not working. You'll be able to debug this based on the session recorder right?"

2. **Self-diagnose**: "Why can't you tell this from the session recording? What do you need to add?"

3. **Debug pages**: "Help me generate debug log files on a debug page"
```

### Autonomy Expectations

```markdown
## Working Autonomously

1. **Keep going**: "You should be able to run by yourself for a long time! Keep going, use lots of subagents"

2. **Check agent instructions**: "Say 'check the agent instructions' to remember them"

3. **Don't wait**: User expects Claude to keep working overnight with subagents
```

---

## Architectural Patterns User Emphasized

1. **Streaming over batching**: "We shouldn't need to batch anything. It should all be streamed through"

2. **Precomputed only**: "I'm never computing on a phone. Either it's precomputed on disk or you precompute at the same time"

3. **React over DOM**: "Why is there DOM manipulation? Shouldn't everything just be React components?"

4. **Humble objects for external systems**: "Make sure it's all behind the humble object"

5. **Session recording for debugging**: Store user clicks + 4fps pipeline samples for debugging weird bugs

---

## Notes

This retro focused on actionable workflow improvements rather than vanity metrics.

**Key insight:** Most friction comes from:

1. **Git/PR workflow confusion** (12+ instances)
2. **Scope creep** (8+ instances)
3. **Feature misunderstanding** (5+ instances)
4. **Missing test coverage** (4+ instances)

**Pattern:** When user has to say "No" or "Wait" - that's wasted work.

**User expectation:** Claude should be autonomous, use subagents, work overnight, and self-diagnose using session recorder.

Next retro: Track correction count and see if it decreased after applying these fixes.
